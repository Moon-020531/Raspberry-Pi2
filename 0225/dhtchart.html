<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="CACHE-CONTROL" content="NO-CACHE" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì˜¨ë„, ìŠµë„ ì¸¡ì •ê¸°</title>
    
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/4.0.4/highcharts.js"></script>
    
    <script>
        var chart, chart2;
        var socket = io(); 

        socket.on('connect', function() {
            console.log("âœ… ì„œë²„ì™€ ì†Œì¼“ ì—°ê²° ì„±ê³µ!");
            socket.emit('join_web', {room: 'WEB'}); 
        });

        socket.on('dht_chart', function(msg) {
            console.log("ğŸ“© ì›ë³¸ ìˆ˜ì‹  ë°ì´í„°:", msg);

            // ğŸŒŸ í•µì‹¬ í•´ê²° ë¶€ë¶„: ESP32ê°€ ë³´ë‚¸ 'ë¬¸ìì—´'ì„ ì°¨íŠ¸ê°€ ì½ì„ ìˆ˜ ìˆëŠ” 'JSON ê°ì²´'ë¡œ ê°•ì œ ë³€í™˜
            var sensorData;
            try {
                sensorData = typeof msg.data === 'string' ? JSON.parse(msg.data) : msg.data;
            } catch (e) {
                console.error("ë°ì´í„° ë³€í™˜ ì‹¤íŒ¨:", e);
                return; // ì—ëŸ¬ ë‚˜ë©´ ë©ˆì¶¤
            }

            var t = new Date().getTime(); 

            // ë³€í™˜ëœ ë°ì´í„°ì—ì„œ ì˜¨ë„ì™€ ìŠµë„ë¥¼ ë½‘ì•„ëƒ„
            if(sensorData && sensorData.temperature) {
                var tempVal = Number(sensorData.temperature);
                var humiVal = Number(sensorData.humidity);
                
                console.log("ğŸ“ˆ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì˜¨ë„=" + tempVal + ", ìŠµë„=" + humiVal);
                
                charAddPoint([t, tempVal]);
                charAddPoint2([t, humiVal]);
            }
        });

        function charAddPoint(tval) {
            var series = chart.series[0];
            var shift = series.data.length > 20; 
            series.addPoint(tval, true, shift); 
        }

        function charAddPoint2(tval) {
            var series = chart2.series[0];
            var shift2 = series.data.length > 20; 
            series.addPoint(tval, true, shift2); 
        }

        $(function() {
            // ë¡œì»¬ ì‹œê°„ ì‚¬ìš© ì„¤ì •
            Highcharts.setOptions({ global: { useUTC: false } });

            chart = new Highcharts.Chart({
                chart: { renderTo: 'temp', defaultSeriesType: 'spline' },
                title: { text: 'ì‹¤ì‹œê°„ ì˜¨ë„ ë°ì´í„°' },
                xAxis: { type: 'datetime', tickPixelInterval: 120 },
                yAxis: { title: { text: 'ì˜¨ë„(C)' } },
                series: [{ name: 'ì˜¨ë„', data: [] }]
            }); 

            chart2 = new Highcharts.Chart({
                chart: { renderTo: 'humi', defaultSeriesType: 'spline' },
                title: { text: 'ì‹¤ì‹œê°„ ìŠµë„ ë°ì´í„°' },
                xAxis: { type: 'datetime', tickPixelInterval: 120 },
                yAxis: { title: { text: 'ìŠµë„(%)' } },
                series: [{ name: 'ìŠµë„', data: [] }]
            });
        });    
    </script>
</head>
<body>
    <div id="temp" style="width:100%; height:300px; margin-bottom: 20px;"></div>
    <div id="humi" style="width:100%; height:300px;"></div>
    <hr>
    <button onclick="location.href='/'">ì œì–´ í˜ì´ì§€ë¡œ ì´ë™</button>
</body>
</html>